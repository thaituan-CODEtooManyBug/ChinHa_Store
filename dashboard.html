<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Admin Dashboard - Chin Hạ Store</title>
    <link href="assets/css/main.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet"> 
    <!-- Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<!-- TUI CodeSnippet -->
<script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.min.js"></script>
<!-- TUI Dom -->
<script src="https://uicdn.toast.com/tui.dom/latest/tui-dom.min.js"></script>
<!-- TUI TimePicker -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.css" />
<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>
<!-- TUI DatePicker -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.css" />
<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>

<!-- TUI Calendar CSS & JS từ jsDelivr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-calendar@1.15.3/dist/tui-calendar.min.css" />
<script src="https://cdn.jsdelivr.net/npm/tui-calendar@1.15.3/dist/tui-calendar.min.js"></script>
    <style>
        body {
            background: #f8f9fa;
        }

        .sidebar {
            min-height: 100vh;
            background: #ffffff;
            color: #fff;
            padding-top: 30px;
        }
        /* Logo area at top of sidebar */
        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px 16px; /* tăng padding một chút */
            margin-bottom: 12px;
        }
        .sidebar-logo img {
            height: 200px;          /* tăng chiều cao logo */
            max-height: 200px;     /* trần tối đa nếu ảnh rất lớn */
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }

        .sidebar .nav-link {
            color: #bfc9d4;
            font-weight: 500;
            margin-bottom: 10px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .sidebar .nav-link {
            color: #bfc9d4;
            font-weight: 500;
            margin-bottom: 10px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background: #156fa3;
            color: #ffffff;
        }

        .sidebar .nav-link i {
            margin-right: 8px;
        }

        .main-content {
            padding: 40px 30px 30px 30px;
        }

        .admin-tab {
            display: none;
        }

        .admin-tab.active {
            display: block;
            background: #ffffff;
            border: #156fa3;
        }
        .admin-tab h1{
            color: #020202;
        }
        .rentalStats h1{
            color: #020202;
        }

        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                padding-top: 10px;
            }

            .main-content {
                padding: 20px 5px;
            }
        }
        .fc-dot-group span {
        border: 1px solid #222;
}
        .cameraManager {
            background-color: #ffffff;
            border-color: #156fa3;
        }
        .fc-daygrid-day-frame {
            position: relative;
            cursor: pointer;
        }
        .fc-dot-group {
            position: absolute;
            right: 4px;
            bottom: 4px;
            display: flex;
            gap: 2px;
            z-index: 5;
        }
        .fc-daygrid-day-number {
            position: absolute;
            top: 4px;
            left: 0% ;   /* Đổi từ 6px thành 8px hoặc 10px */
            font-weight: 500;
            z-index: 6;
            pointer-events: none;
        }
        .dot-legend {
            margin-top: 10px;
            font-size: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            align-items: center;
        }
        .dot-legend .dot {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 6px;
            border: 1px solid #222;
            vertical-align: middle;
        }
        .tui-full-calendar-time-schedule-content {
    width: 10px !important;
    height: 10px !important;
    border-radius: 50%;
    margin: 0 2px;
    display: inline-block;
    padding: 0 !important;
}
/* Ẩn highlight khi chọn ngày trên Tui Calendar */
.tui-full-calendar-weekday-grid-cell-selected,
.tui-full-calendar-weekday-grid-cell.tui-full-calendar-weekday-grid-cell-selected {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
}
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="position-sticky">
                    <div class="sidebar-logo">
                        <a href="index.html" class="d-block" aria-label="Chin Hạ Store">
                            <img id="sidebarLogo" src="./assets/img/logo.png" alt="Chin Hạ Store Logo">
                        </a>
                    </div>
                    <div class="text-center mb-4">
                        <a href="index.html" class="text-decoration-none text-white">
                            <h4>CHIN HẠ ADMIN</h4>
                        </a>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" data-target="rentalStats" href="#">
                                <i class="bi bi-calendar-check"></i> Quản lý lịch thuê
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" data-target="cameraManager" href="#">
                                <i class="bi bi-camera"></i> Quản lý máy ảnh
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" data-target="customerManager" href="#">
                                <i class="bi bi-people"></i> Quản lý dữ liệu khách hàng
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" data-target="editRental" href="#">
                                <i class="bi bi-pencil-square"></i> Chỉnh sửa lịch thuê
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" data-target="statChart" href="#">
                                <i class="bi bi-bar-chart"></i> Thống kê dạng biểu đồ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto mazin-content">
                <section id="rentalStats" class="admin-tab">
                    <h1>Thống Kê Cho Thuê</h1>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="date" id="rentalStatsDate" class="form-control" value="">
                        </div>

                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="rentalStatsTable">
                            <thead>
                                <tr>
                                    <th>Tên khách</th>
                                    <th>SĐT</th>
                                    <th>Máy</th>
                                    <th>Kiểu thuê</th>
                                    <th>Ngày thuê</th>
                                    <th>Ngày trả</th>
                                    <th>Giờ nhận</th>
                                    <th>Giờ trả</th>
                                    
                                </tr>
                            </thead>
                            <tbody id="statsContent">
                                <tr>
                                    <td colspan="8">
                                        <span class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></span>
                                        Đang tải dữ liệu...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="rentalCalendar-hero">
                        <h1>Lịch Thuê Máy Ảnh</h1>
                        <div id="tuiCalendar" style="height: 600px;"></div>
                        <div class="dot-legend mt-2">
                            <span style="color: #000000;"><span class="dot" style="background:#4caf50;"></span>Canon G7x Mark II</span>
                            <span style="color: #000000;"><span class="dot" style="background:#2196f3"></span>Fujifilm X100VI</span>
                            <span style="color: #000000;"><span class="dot" style="background:#e91e63"></span>Canon EOS R50</span>
                            <span style="color: #000000;"><span class="dot" style="background:#ffeb3b"></span>Canon G7x</span>
                            <span style="color: #000000;"><span class="dot" style="background:#9c27b0"></span>DJI Pocket 3</span>
                            <span style="color: #000000;"><span class="dot" style="background:#ff9800"></span>Fujifilm XT30 Mark II</span>
                            <span style="color: #000000;"><span class="dot" style="background:#795548"></span>Fujifilm XM5</span>
                            <span style="color: #000000;"><span class="dot" style="background:#00bcd4"></span>Ricoh GR IV</span>
                            </div>
                    </div>
                </section>
                <section id="cameraManager" class="admin-tab">
                    <h1>Quản Lý Máy Ảnh</h1>
                    <div class="mb-3 text-end">
                        <button id="addCameraBtn" class="btn btn-primary">Thêm Máy Ảnh</button>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên Máy</th>
                                <th>Model</th>
                                <th>Tình Trạng</th>
                                <th>Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="cameraList">
                            <!-- Camera entries will be populated here -->
                        </tbody>
                    </table>
                </section>
                <section id="dailyStats" class="admin-tab">
                    <h1>Thống Kê Theo Ngày</h1>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="date" id="statDate" class="form-control" value="">
                        </div>
                        <div class="col-md-2">
                            <button id="loadDailyStats" class="btn btn-info">Xem</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dailyStatsTable">
                            <thead>
                                <tr>
                                    <th>Tên máy</th>
                                    <th>Model</th>
                                    <th>Khung giờ đã đặt</th>
                                </tr>
                            </thead>
                            <tbody id="dailyStatsContent">
                                <tr>
                                    <td colspan="3">Chọn ngày để xem thống kê.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <section id="customerManager" class="admin-tab">
                    <h1>Quản Lý Dữ Liệu Khách Hàng</h1>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="customerTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tên khách</th>
                                    <th>SĐT</th>
                                    <th>Email</th>
                                    <th>Địa chỉ</th>
                                </tr>
                            </thead>
                            <tbody id="customerList">
                                <tr>
                                    <td colspan="5">Đang tải dữ liệu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <section id="editRental" class="admin-tab">
                    <h1>Chỉnh Sửa Lịch Thuê</h1>
                    <p>Chức năng này sẽ được phát triển thêm.</p>
                </section>
                <section id="statChart" class="admin-tab">
                    <h1>Thống Kê Dạng Biểu Đồ</h1>
                    <canvas id="rentalChart" height="80"></canvas>
                    <p class="text-muted">Biểu đồ sẽ hiển thị khi có dữ liệu.</p>
                </section>
            </main>
        </div>
    </div>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="assets/js/dxshb.js"></script>
    <script>
    // Đặt đoạn này sau tất cả các script phụ thuộc
    const calendar = new tui.Calendar('#tuiCalendar', {
        defaultView: 'month',
        taskView: false,
        scheduleView: ['month'],
        useDetailPopup: false,
        useCreationPopup: false,
        month: { startDayOfWeek: 0 }
    });
    // ...các hàm renderDots, fetchAndRenderTuiDots...
    </script>
    <script>
        // Fetch khách hàng
        fetch("http://localhost:5583/api/customers")
            .then(res => res.json())
            .then(list => {
                const tbody = document.getElementById("customerList");
                if (!list.length) {
                    tbody.innerHTML = `<tr><td colspan="5">Không có dữ liệu.</td></tr>`;
                    return;
                }
                tbody.innerHTML = "";
                list.forEach(c => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.name}</td>
                            <td>${c.phone}</td>
                            <td>${c.email || ""}</td>
                            <td>${c.address || ""}</td>
                        </tr>
                    `;
                });
            })
            .catch(() => {
                document.getElementById("customerList").innerHTML = `<tr><td colspan="5">Không thể tải dữ liệu.</td></tr>`;
            });

        // Biểu đồ thống kê (demo)
        fetch("http://localhost:5583/api/rental-stats")
            .then(res => res.json())
            .then(stats => {
                const ctx = document.getElementById('rentalChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Tổng số lượt thuê', 'Máy đang cho thuê'],
                        datasets: [{
                            label: 'Thống kê',
                            data: [stats.total_rentals, stats.active_rentals],
                            backgroundColor: ['#156fa3', '#f59e42']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend:
                            {
                                display: false
                            }
                        }
                    }
                });
            });

        // Trạng thái cho cơ chế hold/queue
        window.__rentalStatsPending = false;
        window.__rentalStatsNextDate = null;

        function loadRentalStats(dateStr = "") {
            const tbody = document.getElementById("statsContent");
            if (!tbody) return;

            // Nếu đang pending, xếp lịch gọi lại với date mới (lấy request cuối cùng)
            if (window.__rentalStatsPending) {
                window.__rentalStatsNextDate = dateStr ?? "";
                return;
            }

            window.__rentalStatsPending = true;

            // Hiển thị loading ngay lập tức
            tbody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <span class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></span>
                        Đang tải dữ liệu...
                    </td>
                </tr>
            `;

            let url = "http://localhost:5583/api/rentals-detail";
            if (dateStr) url += "?date=" + dateStr;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const list = data && data.rentals ? data.rentals : data;
                    if (!list || !list.length) {
                        tbody.innerHTML = `<tr><td colspan="8">Không có dữ liệu.</td></tr>`;
                        return;
                    }
                    tbody.innerHTML = list.map(r => `
                        <tr>
                            <td>${r.customer_name || ""}</td>
                            <td>${r.customer_phone || ""}</td>
                            <td>${r.camera_name || ""}</td>
                            <td>${r.rental_type === 'date' ? 'Ngày' : 'Giờ'}</td>
                            <td>${r.rental_date || ""}</td>
                            <td>${r.return_date || ""}</td>
                            <td>${r.start_time || ""}</td>
                            <td>${r.end_time || ""}</td>
                        </tr>
                    `).join("");
                })
                .catch(err => {
                    console.error("loadRentalStats error:", err);
                    // Giữ nguyên "Đang tải dữ liệu..." nếu lỗi/timeout/treo server
                })
                .finally(() => {
                    window.__rentalStatsPending = false;

                    // Nếu trong lúc pending có yêu cầu mới, gọi lại với yêu cầu cuối cùng
                    if (window.__rentalStatsNextDate !== null) {
                        const next = window.__rentalStatsNextDate;
                        window.__rentalStatsNextDate = null;
                        loadRentalStats(next);
                    }
                });
        }



        // Tab navigation logic
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                // Remove active from all links
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                // Hide all tabs
                document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
                // Show selected tab
                const target = this.getAttribute('data-target');
                if (target) {
                    document.getElementById(target).classList.add('active');
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            });
        });
        // Show first tab by default
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('.admin-tab').classList.add('active');
        });
        // Tải mặc định khi vào trang
        loadRentalStats();
        const cameraColors = [
            "#4caf50", "#2196f3", "#e91e63", "#ffeb3b",
            "#9c27b0", "#ff9800", "#795548", "#00bcd4"
        ];

        function renderDots(dots) {
            calendar.clear(); // Đúng cho Tui Calendar v1.x
            Object.entries(dots).forEach(([date, camArr]) => {
                camArr.forEach((camId, idx) => {
                    calendar.createSchedules([{
                        id: `${date}-${camId}`,
                        calendarId: '1',
                        title: '',
                        category: 'time',
                        start: date + 'T00:00:00',
                        end: date + 'T23:59:59',
                        isAllDay: true,
                        bgColor: cameraColors[(camId-1)%cameraColors.length],
                        borderColor: cameraColors[(camId-1)%cameraColors.length],
                        color: cameraColors[(camId-1)%cameraColors.length],
                        raw: { camId }
                    }]);
                });
            });
        }

        function fetchAndRenderTuiDots(month) {
            fetch("http://localhost:5583/api/rentals-detail?month=" + month)
                .then(res => res.json())
                .then(data => {
                    renderDots(data.dots || {});
                });
        }

        calendar.on('beforeRenderSchedule', function() {
            const date = calendar.getDate();
            const month = date.getFullYear() + '-' + String(date.getMonth()+1).padStart(2,'0');
            fetchAndRenderTuiDots(month);
        });

        document.addEventListener('DOMContentLoaded', function() {
            const date = calendar.getDate();
            const month = date.getFullYear() + '-' + String(date.getMonth()+1).padStart(2,'0');
            fetchAndRenderTuiDots(month);
        });
        setTimeout(() => {
            if (calendar) calendar.render();
        }, 300);

        document.querySelector('[data-target="rentalStats"]').addEventListener('click', function() {
            setTimeout(() => {
                if (calendar) calendar.render();
            }, 200);
        });
    calendar.on('clickDay', function(event) {
    // Đưa lịch về đúng tháng chứa ngày vừa click
    calendar.setDate(event.date);

    // Lấy ngày dạng YYYY-MM-DD
    const dateStr = moment(event.date).format('YYYY-MM-DD');

    // Set lại giá trị cho input date (nếu input tồn tại)
    var dateInput = document.getElementById("rentalStatsDate");
    if (dateInput) {
        dateInput.value = dateStr;
    }

    // Hiển thị bảng cho ngày đó
    loadRentalStats(dateStr);
});

// Khi đổi ngày bằng input date, cũng cập nhật lịch
document.getElementById("rentalStatsDate").addEventListener("change", function() {
    const dateStr = this.value;
    if (dateStr) {
        // Đưa lịch về đúng ngày
        calendar.setDate(new Date(dateStr));
        loadRentalStats(dateStr);
    }
});

// Khi vào trang, nếu input date chưa có giá trị thì set về hôm nay
document.addEventListener('DOMContentLoaded', function() {
    var dateInput = document.getElementById("rentalStatsDate");
    if (dateInput && !dateInput.value) {
        const today = moment().format('YYYY-MM-DD');
        dateInput.value = today;
        loadRentalStats(today);
        calendar.setDate(new Date(today));
    }
});

    </script>
</body>

</html>